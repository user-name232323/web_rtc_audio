<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta charset="UTF-8">
    <title>Audial - –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        #login {
            width: 100%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 32px;
            animation: slideUp 0.3s ease;
        }
        
        #app {
            width: 100%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 32px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #f0f0f0;
            color: #333;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-call {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
        }

        .btn-forward {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
            margin-left: 8px;
        }

        .btn-end {
            background: linear-gradient(135deg, #eb3349, #f45c43);
            color: white;
        }

        .btn-mute {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #status {
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 24px;
            font-weight: 500;
            text-align: center;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .status-ready {
            background: #e8f5e9;
            color: #2e7d32;
            border-left-color: #4caf50;
        }

        .status-calling {
            background: #fff3e0;
            color: #f57c00;
            border-left-color: #ff9800;
        }

        .status-connected {
            background: #e3f2fd;
            color: #1976d2;
            border-left-color: #2196f3;
        }

        .call-info {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-align: center;
            border: 1px solid #667eea30;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        #callStatus {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        #callTime {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            font-variant-numeric: tabular-nums;
        }

        .users-panel {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 20px;
            margin: 24px 0;
        }

        .users-panel h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #userCount {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 8px;
        }

        .user-item {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-item:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .user-item strong {
            font-size: 16px;
            color: #1a1a1a;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .call-controls {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .call-controls .btn {
            flex: 1;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            color: #eb3349;
            font-size: 14px;
            margin-top: 12px;
            padding: 12px;
            background: #ffebee;
            border-radius: 12px;
            text-align: center;
        }

        .avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
        }

        .incoming-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .incoming-box {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .incoming-box h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .incoming-box p {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            margin: 16px 0;
            padding: 16px;
            background: #f0f2ff;
            border-radius: 12px;
        }

        .incoming-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .accept-btn {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            flex: 1;
        }

        .decline-btn {
            background: linear-gradient(135deg, #eb3349, #f45c43);
            flex: 1;
        }

        .trusted-users-list {
            max-height: 250px;
            overflow-y: auto;
            margin: 16px 0;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
        }

        .trusted-info {
            font-size: 14px;
            color: #9c27b0;
            margin-top: 4px;
            font-style: italic;
        }

        @media (max-width: 480px) {
            #login, #app {
                padding: 24px;
            }

            .call-controls {
                flex-direction: column;
            }

            .user-item {
                flex-direction: column;
                gap: 12px;
            }

            .user-item .btn {
                width: 100%;
            }

            .user-actions {
                width: 100%;
                flex-direction: column;
            }

            .incoming-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div id="login">
        <div class="avatar">üé§</div>
        <h1>Audial</h1>
        <div class="subtitle">–ì–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
        
        <div class="input-group">
            <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" autocomplete="off">
        </div>
        
        <button onclick="login()" class="btn btn-primary">
            <span>üì±</span> –í–æ–π—Ç–∏ –≤ —á–∞—Ç
        </button>
        
        <div id="loginError" class="error-message hidden"></div>
    </div>

    <div id="app" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h1 style="margin-bottom: 0;">Audial</h1>
            <span style="background: #f0f0f0; padding: 8px 16px; border-radius: 20px; font-size: 14px;">
                üü¢ –û–Ω–ª–∞–π–Ω
            </span>
        </div>

        <div id="status" class="status-ready">
            üé§ –ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º
        </div>

        <div id="callInfo" class="call-info hidden">
            <div id="callStatus">–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω</div>
            <div id="callTime">00:00</div>
        </div>

        <div class="users-panel">
            <h2>
                <span>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</span>
                <span id="userCount">0</span>
            </h2>
            <div id="userList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="call-controls">
            <button onclick="toggleMute()" id="muteBtn" class="btn btn-mute" disabled>
                üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
            <button onclick="endCall()" id="endCallBtn" class="btn btn-end" disabled>
                üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å
            </button>
        </div>

        <audio id="remoteAudio" autoplay></audio>
    </div>

    <div id="incomingCallModal" class="incoming-modal hidden">
        <div class="incoming-box">
            <div class="avatar">üìû</div>
            <h2>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h2>
            <p id="callerName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
            <div id="trustedDisplay" class="trusted-info"></div>
            <div class="incoming-buttons">
                <button class="btn accept-btn" onclick="acceptCall()">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="btn decline-btn" onclick="declineCall()">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—è -->
    <div id="forwardModal" class="incoming-modal hidden">
        <div class="incoming-box">
            <div class="avatar">üîÑ</div>
            <h2>–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞ <strong id="forwardTargetName"></strong></p>
            <div id="trustedUsersList" class="trusted-users-list">
                <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="incoming-buttons">
                <button class="btn decline-btn" onclick="closeForwardModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—é -->
    <div id="trustedRequestModal" class="incoming-modal hidden">
        <div class="incoming-box">
            <div class="avatar">ü§ù</div>
            <h2>–ó–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏</h2>
            <p id="forwardRequestInfo">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫</p>
            <div class="incoming-buttons">
                <button class="btn accept-btn" onclick="acceptForwardRequest()">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="btn decline-btn" onclick="declineForwardRequest()">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        // ========== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
        console.log("üîç –°–∞–π—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");
        console.log("üîç localStorage —Ç–æ–∫–µ–Ω:", localStorage.getItem('fcm_token'));
        console.log("üîç Android –¥–æ—Å—Ç—É–ø–µ–Ω:", !!window.Android);
        if (window.Android) {
            console.log("üîç –ú–µ—Ç–æ–¥ getToken –¥–æ—Å—Ç—É–ø–µ–Ω:", typeof window.Android.getToken === 'function');
            console.log("üîç –ú–µ—Ç–æ–¥ stopRingtone –¥–æ—Å—Ç—É–ø–µ–Ω:", typeof window.Android.stopRingtone === 'function');
        }

        let socket;
        let pc;
        let localStream;
        let currentCall = null;
        let isMuted = false;
        let callStartTime = 0;
        let callTimer = null;
        let incomingCallData = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏
        let forwardTarget = null;
        let forwardRequestData = null;
        let allUsers = [];

        // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –¢–û–ö–ï–ù–ê ==========
        function sendTokenToServer(username, token) {
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è', username);
            console.log('üì§ –¢–æ–∫–µ–Ω:', token.substring(0, 20) + '...');
            
            const url = '/save-token';
            console.log('üîç URL:', url);
            
            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    token: token
                })
            })
            .then(res => {
                console.log('üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {
                    console.log('üéâ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è', username);
                }
            })
            .catch(err => {
                console.error('‚ùå –û—à–∏–±–∫–∞ fetch:', err);
                console.error('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ:', err.message);
            });
        }

        // ========== –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê –û–¢ ANDROID ==========
        window.onAndroidToken = function(token) {
            console.log('üì± –¢–æ–∫–µ–Ω –æ—Ç Android –ü–û–õ–£–ß–ï–ù!');
            console.log('üì± –¢–æ–∫–µ–Ω:', token.substring(0, 20) + '...');
            console.log('üîç –î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞:', token.length);
            
            localStorage.setItem('fcm_token', token);
            console.log('üíæ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('üîç currentUsername =', window.currentUsername);
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
            if (window.currentUsername) {
                sendTokenToServer(window.currentUsername, token);
            } else {
                console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ª–æ–≥–∏–Ω–∞, —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage');
            }
        };

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –ó–í–û–ù–ö–ê –ò–ó PUSH –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
        window.handleIncomingCallFromPush = function(caller, callId) {
            console.log('üìû –ó–í–û–ù–û–ö –ò–ó PUSH! caller:', caller, 'callId:', callId);
            
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (incomingCallData) {
                console.log('‚è≥ –£–∂–µ –µ—Å—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º push');
                return;
            }
            
            // –ï—Å–ª–∏ —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (currentCall) {
                console.log('‚è≥ –£–∂–µ –≤ –∑–≤–æ–Ω–∫–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º push');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('callerName').textContent = caller;
            document.getElementById('incomingCallModal').classList.remove('hidden');
            
            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
            incomingCallData = {
                from: callId,
                fromName: caller,
                offer: null  // –í push –Ω–µ—Ç offer, –æ–Ω –ø—Ä–∏–¥–µ—Ç —á–µ—Ä–µ–∑ WebSocket
            };
            
            console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ, –∂–¥–µ–º offer —á–µ—Ä–µ–∑ WebSocket');
        };

        async function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });
                
                console.log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                socket = io();
                socket.emit('login', username);
                
                // ========== –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê –¢–û–ö–ï–ù–ê –ü–†–ò –õ–û–ì–ò–ù–ï ==========
                const savedToken = localStorage.getItem('fcm_token');
                if (savedToken) {
                    console.log('üì§ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ');
                    sendTokenToServer(username, savedToken);
                } else {
                    console.log('‚è≥ –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –≤ localStorage');
                }
                
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                showStatus('‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ' + username, 'status-ready');
                
                setupSocketListeners();
                
            } catch (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', err);
                
                if (err.name === 'NotAllowedError') {
                    showError('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                } else if (err.name === 'NotFoundError') {
                    showError('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.');
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + err.message);
                }
            }
        }
        
        function setupSocketListeners() {
            socket.on('users', (users) => {
                allUsers = users;
                updateUserList(users);
            });
            
            socket.on('incoming-call', (data) => {
                console.log('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ WebSocket:', data);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–π –∑–≤–æ–Ω–æ–∫ –∏–∑ push, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–º–∏
                if (incomingCallData && incomingCallData.from === data.from) {
                    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞ –∏–∑ push');
                    incomingCallData.offer = data.offer;
                } else {
                    // –û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
                    handleIncomingCall(data);
                }
            });
            
            socket.on('call-answered', (data) => {
                handleCallAnswered(data);
            });
            
            socket.on('ice-candidate', (data) => {
                handleIceCandidate(data);
            });
            
            socket.on('call-ended', (data) => {
                endCall();
                showStatus('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'status-ready');
            });
            
            socket.on('login', (username) => {
                // üî• –°–û–•–†–ê–ù–Ø–ï–ú –ò–ú–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                window.currentUsername = username;
                console.log('üë§ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', username);
                
                // üî• –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω –æ—Ç Android, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const token = localStorage.getItem('fcm_token');
                if (token) {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è', username, '(–∏–∑ —Å–æ–±—ã—Ç–∏—è login)');
                    sendTokenToServer(username, token);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏
            socket.on('forward-request', (data) => {
                handleForwardRequest(data);
            });
            
            socket.on('forward-approved', (data) => {
                handleForwardApproved(data);
            });
            
            socket.on('forward-rejected', () => {
                alert('–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å');
                showStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º', 'status-ready');
            });
        }
        
        function updateUserList(users) {
            const currentId = socket.id;
            const userList = document.getElementById('userList');
            
            const otherUsers = users.filter(u => u.id !== currentId);
            
            document.getElementById('userCount').textContent = otherUsers.length;
            
            if (otherUsers.length === 0) {
                userList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">üëÄ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }
            
            let html = '';
            otherUsers.forEach(user => {
                html += `
                <div class="user-item">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">üë§</span>
                        <strong>${user.name}</strong>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-call" onclick="startCall('${user.id}', '${user.name}')" style="padding: 12px 20px;">
                            üìû
                        </button>
                        <button class="btn btn-forward" onclick="openForwardModal('${user.id}', '${user.name}')" style="padding: 12px 20px;">
                            üîÑ
                        </button>
                    </div>
                </div>
                `;
            });
            
            userList.innerHTML = html;
        }
        
        function openForwardModal(targetId, targetName) {
            if (currentCall) {
                alert('–£–∂–µ –≤ –∑–≤–æ–Ω–∫–µ. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫.');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            forwardTarget = { id: targetId, name: targetName };
            
            document.getElementById('forwardTargetName').textContent = targetName;
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª–µ–π (–≤—Å–µ –∫—Ä–æ–º–µ —Å–µ–±—è –∏ —Ü–µ–ª–∏)
            const currentId = socket.id;
            const otherUsers = allUsers.filter(u => u.id !== currentId && u.id !== targetId);
            
            if (otherUsers.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–≤–µ—Ä–∏—Ç–µ–ª–µ–π');
                return;
            }
            
            let html = '';
            otherUsers.forEach(user => {
                html += `
                <div style="background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">üë§</span>
                        <strong>${user.name}</strong>
                    </div>
                    <button onclick="selectTrustedUser('${user.id}', '${user.name}')" style="background: linear-gradient(135deg, #00b09b, #96c93d); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; width: auto;">
                        –í—ã–±—Ä–∞—Ç—å
                    </button>
                </div>
                `;
            });
            
            document.getElementById('trustedUsersList').innerHTML = html;
            document.getElementById('forwardModal').classList.remove('hidden');
        }
        
        function closeForwardModal() {
            document.getElementById('forwardModal').classList.add('hidden');
            // –ù–ï –æ—á–∏—â–∞–µ–º forwardTarget, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å
        }
        
        function selectTrustedUser(trustedId, trustedName) {
            console.log('–í—ã–±—Ä–∞–Ω –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å:', trustedName);
            console.log('–¶–µ–ª—å –∑–≤–æ–Ω–∫–∞:', forwardTarget);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('forwardModal').classList.add('hidden');
            
            if (!forwardTarget) {
                alert('–û—à–∏–±–∫–∞: —Ü–µ–ª—å –∑–≤–æ–Ω–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                return;
            }
            
            showStatus(`üìû –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É ${trustedName}...`, 'status-calling');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—é
            socket.emit('forward-call', {
                trustedId: trustedId,
                targetId: forwardTarget.id,
                targetName: forwardTarget.name
            });
            
            console.log('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        }
        
        function handleForwardRequest(data) {
            console.log('–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏:', data);
            forwardRequestData = data;
            document.getElementById('forwardRequestInfo').innerHTML = 
                `<strong>${data.callerName}</strong> —Ö–æ—á–µ—Ç –ø–æ–∑–≤–æ–Ω–∏—Ç—å <strong>${data.targetName}</strong><br>–ß–µ—Ä–µ–∑ –≤–∞—Å`;
            document.getElementById('trustedRequestModal').classList.remove('hidden');
        }
        
        function acceptForwardRequest() {
            // üî• –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ú–ï–õ–û–î–ò–Æ –ü–†–ò –û–î–û–ë–†–ï–ù–ò–ò –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–ò
            if (window.Android) {
                window.Android.stopRingtone();
                console.log("üîá –ú–µ–ª–æ–¥–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏");
            }
            
            document.getElementById('trustedRequestModal').classList.add('hidden');
            
            if (!forwardRequestData) return;
            
            console.log('–û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è:', forwardRequestData.callerName);
            
            // –û–¥–æ–±—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å
            socket.emit('forward-accept', {
                callerId: forwardRequestData.callerId,
                targetId: forwardRequestData.targetId,
                targetName: forwardRequestData.targetName
            });
            
            forwardRequestData = null;
        }
        
        function declineForwardRequest() {
            // üî• –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ú–ï–õ–û–î–ò–Æ –ü–†–ò –û–¢–ö–õ–û–ù–ï–ù–ò–ò –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–ò
            if (window.Android) {
                window.Android.stopRingtone();
                console.log("üîá –ú–µ–ª–æ–¥–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏");
            }
            
            document.getElementById('trustedRequestModal').classList.add('hidden');
            if (forwardRequestData) {
                socket.emit('forward-reject', {
                    callerId: forwardRequestData.callerId
                });
            }
            forwardRequestData = null;
        }
        
        function handleForwardApproved(data) {
            console.log('–ó–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω, –∑–≤–æ–Ω—é:', data.targetName, '—á–µ—Ä–µ–∑ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—è:', data.trustedName);
            showStatus(`üìû –ó–≤–æ–Ω–æ–∫ ${data.targetName}...`, 'status-calling');
            
            // –ó–≤–æ–Ω–∏–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª–µ
            startCallWithTrusted(data.targetId, data.targetName, data.trustedName);
        }
        
        async function startCallWithTrusted(targetId, targetName, trustedName) {
            if (currentCall) {
                alert('–£–∂–µ –≤ –∑–≤–æ–Ω–∫–µ. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫.');
                return;
            }
            
            currentCall = { id: targetId, name: targetName };
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                localStream.getAudioTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
                
                pc.ontrack = (event) => {
                    console.log('‚úÖ –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');
                    const remoteAudio = document.getElementById('remoteAudio');
                    
                    if (event.streams && event.streams[0]) {
                        remoteAudio.srcObject = event.streams[0];
                        startCallTimer();
                        showCallInfo(targetName);
                        showStatus(`üéß –†–∞–∑–≥–æ–≤–æ—Ä —Å ${targetName}`, 'status-connected');
                        
                        remoteAudio.play().catch(e => {
                            console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
                        });
                    }
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate && currentCall) {
                        socket.emit('ice-candidate', {
                            to: currentCall.id,
                            candidate: event.candidate
                        });
                    }
                };
                
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false
                });
                
                await pc.setLocalDescription(offer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–≤–æ–Ω–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª–µ
                socket.emit('call', {
                    to: targetId,
                    offer: offer,
                    callType: 'audio',
                    trustedByName: trustedName
                });
                
                document.getElementById('muteBtn').disabled = false;
                document.getElementById('endCallBtn').disabled = false;
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞:', err);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞', 'status-ready');
                endCall();
            }
        }
        
        async function startCall(targetId, targetName) {
            if (currentCall) {
                alert('–£–∂–µ –≤ –∑–≤–æ–Ω–∫–µ. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫.');
                return;
            }
            
            currentCall = { id: targetId, name: targetName };
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                localStream.getAudioTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
                
                pc.ontrack = (event) => {
                    console.log('‚úÖ –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');
                    const remoteAudio = document.getElementById('remoteAudio');
                    
                    if (event.streams && event.streams[0]) {
                        remoteAudio.srcObject = event.streams[0];
                        startCallTimer();
                        showCallInfo(targetName);
                        showStatus(`üéß –†–∞–∑–≥–æ–≤–æ—Ä —Å ${targetName}`, 'status-connected');
                        
                        remoteAudio.play().catch(e => {
                            console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
                        });
                    }
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate && currentCall) {
                        socket.emit('ice-candidate', {
                            to: currentCall.id,
                            candidate: event.candidate
                        });
                    }
                };
                
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false
                });
                
                await pc.setLocalDescription(offer);
                
                socket.emit('call', {
                    to: targetId,
                    offer: offer,
                    callType: 'audio'
                });
                
                document.getElementById('muteBtn').disabled = false;
                document.getElementById('endCallBtn').disabled = false;
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞:', err);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞', 'status-ready');
                endCall();
            }
        }
        
        function handleIncomingCall(data) {
            if (currentCall) {
                console.log('–ó–∞–Ω—è—Ç–æ, –∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                return;
            }

            incomingCallData = data;
            document.getElementById('callerName').textContent = data.fromName;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
            const trustedDisplay = document.getElementById('trustedDisplay');
            if (data.trustedByName) {
                trustedDisplay.textContent = `üìû —á–µ—Ä–µ–∑ ${data.trustedByName}`;
                trustedDisplay.style.display = 'block';
            } else {
                trustedDisplay.style.display = 'none';
            }
            
            document.getElementById('incomingCallModal').classList.remove('hidden');
        }

        // ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–°–¢–ê–ù–û–í–ö–ò –ú–ï–õ–û–î–ò–ò ==========
        function stopRingtone() {
            console.log("üîç stopRingtone() –≤—ã–∑–≤–∞–Ω–∞");
            console.log("üîç window.Android –¥–æ—Å—Ç—É–ø–µ–Ω?", !!window.Android);
            
            if (window.Android) {
                console.log("üîç –¢–∏–ø stopRingtone:", typeof window.Android.stopRingtone);
                
                if (typeof window.Android.stopRingtone === 'function') {
                    try {
                        window.Android.stopRingtone();
                        console.log("‚úÖ –ö–æ–º–∞–Ω–¥–∞ stopRingtone –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ APK");
                        return true;
                    } catch (e) {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ stopRingtone:", e);
                        return false;
                    }
                } else {
                    console.log("‚ö†Ô∏è stopRingtone –Ω–µ —Ñ—É–Ω–∫—Ü–∏—è");
                    return false;
                }
            } else {
                console.log("‚ö†Ô∏è Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                return false;
            }
        }

        async function acceptCall() {
            console.log("üìû acceptCall() –Ω–∞—á–∞—Ç–∞");
            
            // üî• –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ú–ï–õ–û–î–ò–Æ –ü–†–ò –û–¢–í–ï–¢–ï
            stopRingtone();

            document.getElementById('incomingCallModal').classList.add('hidden');
            const data = incomingCallData;
            
            if (!data) {
                console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞');
                return;
            }
            
            currentCall = { id: data.from, name: data.fromName };
            showStatus(`üìû –ü—Ä–∏–Ω–∏–º–∞—é –∑–≤–æ–Ω–æ–∫ –æ—Ç ${data.fromName}...`, 'status-calling');
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                localStream.getAudioTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
                
                pc.ontrack = (event) => {
                    console.log('‚úÖ –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');
                    const remoteAudio = document.getElementById('remoteAudio');
                    
                    if (event.streams && event.streams[0]) {
                        remoteAudio.srcObject = event.streams[0];
                        startCallTimer();
                        showCallInfo(data.fromName);
                        showStatus(`üéß –†–∞–∑–≥–æ–≤–æ—Ä —Å ${data.fromName}`, 'status-connected');
                        
                        remoteAudio.play().catch(e => {
                            console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
                        });
                    }
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate && currentCall) {
                        socket.emit('ice-candidate', {
                            to: currentCall.id,
                            candidate: event.candidate
                        });
                    }
                };
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å offer, –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫, –µ—Å–ª–∏ –Ω–µ—Ç - –∂–¥–µ–º
                if (data.offer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    
                    const answer = await pc.createAnswer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: false
                    });
                    
                    await pc.setLocalDescription(answer);
                    
                    socket.emit('answer', {
                        to: data.from,
                        answer: answer
                    });
                } else {
                    console.log('‚è≥ –û–∂–∏–¥–∞–µ–º offer –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
                }
                
                document.getElementById('muteBtn').disabled = false;
                document.getElementById('endCallBtn').disabled = false;
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', err);
                showStatus('‚ùå –û—à–∏–±–∫–∞', 'status-ready');
                endCall();
            }
            
            incomingCallData = null;
        }

        function declineCall() {
            console.log("‚ùå declineCall() –Ω–∞—á–∞—Ç–∞");
            
            // üî• –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ú–ï–õ–û–î–ò–Æ –ü–†–ò –û–¢–ö–õ–û–ù–ï–ù–ò–ò
            stopRingtone();
            
            document.getElementById('incomingCallModal').classList.add('hidden');
            incomingCallData = null;
        }
        
        async function handleCallAnswered(data) {
            if (pc && currentCall && currentCall.id === data.from) {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞:', err);
                }
            }
        }
        
        async function handleIceCandidate(data) {
            if (pc && currentCall && currentCall.id === data.from) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ ICE:', err);
                }
            }
        }
        
        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMuted = !audioTracks[0].enabled;
                audioTracks[0].enabled = !isMuted;
                
                const muteBtn = document.getElementById('muteBtn');
                muteBtn.textContent = isMuted ? 'üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                muteBtn.style.background = isMuted ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'linear-gradient(135deg, #f7971e, #ffd200)';
            }
        }
        
        function endCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            if (currentCall) {
                socket.emit('hangup', { to: currentCall.id });
                currentCall = null;
            }
            
            const remoteAudio = document.getElementById('remoteAudio');
            if (remoteAudio.srcObject) {
                remoteAudio.srcObject.getTracks().forEach(track => track.stop());
                remoteAudio.srcObject = null;
            }
            
            document.getElementById('callInfo').classList.add('hidden');
            document.getElementById('muteBtn').disabled = true;
            document.getElementById('endCallBtn').disabled = true;
            document.getElementById('muteBtn').textContent = 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
            document.getElementById('muteBtn').style.background = 'linear-gradient(135deg, #f7971e, #ffd200)';
            
            showStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º', 'status-ready');
        }
        
        function startCallTimer() {
            callStartTime = Date.now();
            document.getElementById('callInfo').classList.remove('hidden');
            
            if (callTimer) clearInterval(callTimer);
            
            callTimer = setInterval(() => {
                const elapsed = Date.now() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('callTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function showCallInfo(remoteName) {
            document.getElementById('callStatus').innerHTML = `üéß –†–∞–∑–≥–æ–≤–æ—Ä —Å <strong>${remoteName}</strong>`;
        }
        
        function showStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = className;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        window.addEventListener('beforeunload', () => {
            endCall();
            if (socket) socket.disconnect();    
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
        }
    </script>
</body>
</html>